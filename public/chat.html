<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" type="text/css" href="../main.css">

    <title>Home</title>
</head>

<body onload="init()">
    <p id="error" style="color: red;"></p>
    <strong id="name">Hello</strong>
    <br />
    <a href="/home">home</a>

    <div id="messages"></div>

    <form onsubmit="return false;">
        <input id="message" type="text" placeholder="Send a message">
    </form>
    
    <button onclick="send()">Send</button>
</body>

<script src="../cookies.js"></script>

<script>
    let xhr = new XMLHttpRequest();
    let user = {};
    const urlParams = new URLSearchParams(window.location.search);
    const chat = urlParams.get("chat");
    let started = false;

    function init() {
        if(!started) {
            xhr.open("GET", "/user", true);
            xhr.send();
            xhr.onload = () => {
                if(xhr.status === 404) {
                    document.location.href = "../login.html";
                } else {
                    user = JSON.parse(xhr.response);
                    console.log(user);
    
                    checkChat();
                }
            }

            started = true;
        }
    }

    function checkChat() {
        xhr.open("GET", "/chat/get?chat=" + chat, true);
        xhr.send();
        xhr.onload = () => {
            if(xhr.status === 200) {
                useChatInfo(JSON.parse(xhr.response));
            } else if(xhr.status === 400) {
                document.getElementById("error").innerHTML = JOSN.parse(xhr.response).error;
            }
        }
    }

    function useChatInfo(chat) {
        let messages = document.getElementById("messages");
        document.getElementById("name").innerHTML = chat.name;
        messages.innerHTML = "";

        for(let i = 0; i < chat.messages.length; i++) {
            if(chat.messages[i].who === user.username) {
                messages.innerHTML += "<p>You: " + chat.messages[i].text + "</p>";
            } else {
                messages.innerHTML += "<p>" + chat.messages[i].who + ": " + chat.messages[i].text + "</p>";
            }
        }
    }

    function send() {
        const message = document.getElementById("message").value;

        fetch("/chat/send", {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8', },
            body: new URLSearchParams({
                chat: chat,
                who: user.username,
                text: message
            })
        })
        .then((resp) => resp.json())
        .then(function(response) {
            if(response.error) {
                document.getElementById("error").innerHTML = response.error;
            } else if(response) {
                useChatInfo(response);
            }

            document.getElementById("message").value = "";

            return response;
        })
    }

    setInterval(checkChat, 1000);
</script>

</html>